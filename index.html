function draw() {
    direction = nextDirection;

    // Move the snake
    let head = { ...snake[0] };
    if (direction === "UP") head.y -= box;
    else if (direction === "DOWN") head.y += box;
    else if (direction === "LEFT") head.x -= box;
    else if (direction === "RIGHT") head.x += box;

    // Wrap snake around screen if it goes out of bounds
    if (head.x < 0) head.x = canvas.width - box;
    else if (head.x >= canvas.width) head.x = 0;
    else if (head.y < 0) head.y = canvas.height - box;
    else if (head.y >= canvas.height) head.y = 0;

    // Add new head to snake array
    snake.unshift(head);

    // Remove the last segment of the snake to maintain its length
    snake.pop();

    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = "red";
    ctx.fillRect(food.x, food.y, box, box);
    
    ctx.fillStyle = "lime";
    snake.forEach(segment => {
        ctx.fillRect(segment.x, segment.y, box, box);
    });

    ctx.fillStyle = "yellow";
    pellets.forEach((pellet, index) => {
        ctx.fillRect(pellet.x + box / 4, pellet.y + box / 4, box / 2, box / 2);
        if (pellet.dir === "UP") pellet.y -= pelletSpeed;
        else if (pellet.dir === "DOWN") pellet.y += pelletSpeed;
        else if (pellet.dir === "LEFT") pellet.x -= pelletSpeed;
        else if (pellet.dir === "RIGHT") pellet.x += pelletSpeed;
        
        enemies.forEach((enemy, eIndex) => {
            if (enemy.some(seg => seg.x === pellet.x && seg.y === pellet.y)) {
                enemies.splice(eIndex, 1);
                enemyDirections.splice(eIndex, 1);
                pellets.splice(index, 1);
            }
        });
    });

    ctx.fillStyle = "blue";
    enemies.forEach(enemy => {
        enemy.forEach(segment => {
            ctx.fillRect(segment.x, segment.y, box, box);
        });
    });

    moveEnemies();
}
